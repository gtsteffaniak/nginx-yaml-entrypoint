limit_req_zones:
  - name: global
    key: $binary_remote_addr
    zone: global:10m
    rate: 100r/s
limit_req_log_level: error
limit_req_status: 429

templateConfigs:
  withSSL:
    configs:
      ssl_certificate: /etc/nginx/ssl/live/example.com/fullchain.pem
      ssl_certificate_key: /etc/nginx/ssl/live/example.com/privkey.pem
  webSocketSupport:
    configs:
      proxy_http_version: 1.1
    proxy_set_header:
      Upgrade: "$http_upgrade"
      Connection: "$http_connection"
  withAuthentication:
    proxy_set_header:
      X-Forwarded-User: "$user"
      Authorization: "$http_authorization"
    configs:
      auth_request: "/auth/authorize"
      auth_request_set: "$auth_status: $upstream_status"
    proxy_pass_header:
      Authorization: true

servers:
  - listen: "443 ssl"
    server_name: "www.mydomain.com"
    applyTemplates:
      - withSSL
    configs:
      server_name_in_redirect: on;
      return: "301: \"https://example.com$request_uri\""
  - listen: "443 ssl"
    server_name: "mydomain.com"
    applyTemplates:
      - withSSL
      - webSocketSupport
    configs:
      http2: on
      server_name_in_redirect: on
      absolute_redirect: off
      proxy_buffering: off
      proxy_buffer_size: 16m
      proxy_busy_buffers_size: 24m
      proxy_buffers: "64 16m"
      limit_req_log_level: error
      limit_req_status: 429
      proxy_cache: my_cache
      proxy_cache_valid: "200 10m"
    limit_req:
      zone: global
      burst: 20
    add_header:
      Content-Type: "text/html"
    locations:
      - path: "/"
        applyTemplates:
          - withAuthentication
        configs:
          proxy_pass: "http://localhost:8080"