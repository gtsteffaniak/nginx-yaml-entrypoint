limit_req_zones:
  - name: global
    key: $binary_remote_addr
    zone: global:10m
    rate: 100r/s
  - name: unlimited
    key: $binary_remote_addr
    zone: unlimited:10m
    rate: 10000r/s
  - name: medium
    key: $binary_remote_addr
    zone: medium:10m
    rate: 25r/s
  - name: strict
    key: $binary_remote_addr
    zone: strict:10m
    rate: 5r/s

proxy_cache_path:
  - path: cache
    levels: 1:2
    keys_zone: my_cache:10m
    max_size: 10g

limit_req_log_level: error
limit_req_status: 429

servers:
  - listen: 80
    name: "main_http"
    server_name: "*.gportal.link gportal.link"
    server_name_in_redirect: on
    if:
      - condition: $host ~* ^(grafana)\.gportal\.link$
        return: 404 https://gportal.link/404
    limit_req:
      zone: global
      burst: 20
    add_header: "Content-Type: text/html"
    return: "301 https://$host$request_uri"
    add_header:
      - "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload"
    locationDefaults:
      configs:
        proxy_cache: my_cache
        proxy_cache_valid: "200 10m"
        proxy_http_version: 1.1
        proxy_buffering: off
        auth_request: "/authorize/authorize"
        auth_request_set: "$auth_status: $upstream_status"
        proxy_set_header: "Authorization: $http_authorization"
        proxy_pass_header: "Authorization"
    locations:
      - path: "^~ /.well-known/acme-challenge"
        configs:
          allow: all
          auth_basic: off
          root: "/var/www/certbot"
      - path: "/share/"
        configs:
          proxy_cache: my_cache
          proxy_cache_valid: "200 10m"
          proxy_cache_valid: "any 0"
          proxy_pass: "http://10.13.13.2:2283/share/"
      - path: "/api/asset/"
        limit_req:
          name: unlimited
          burst: 10000
        configs:
          proxy_cache: my_cache
          proxy_cache_valid: "200 10m"
          proxy_cache_valid: "any 0"
          proxy_pass: "http://10.13.13.2:2283/api/asset/"
      - path: "/_app/immutable/"
        limit_req:
          zone: unlimited
          burst: 10000
        configs:
          proxy_cache: my_cache
          proxy_cache_valid: "200 10m"
          proxy_cache_valid: "any 0"
          proxy_pass: "http://10.13.13.2:2283/_app/immutable/"
      - path: "/authorize/"
        configs:
          proxy_cache: my_cache
          proxy_cache_valid: "200 10m"
          proxy_cache_valid: "any 0"
          proxy_pass: "http://home:8080/authorize/"
          proxy_pass_request_body: off
          proxy_set_header: "Content-Length: ''"
          proxy_set_header: "Authorization: $http_authorization"
          proxy_pass_header: "Authorization"
          proxy_set_header: "X-Original-URI: $request_uri"
        limit_req:
          zone: strict
      - path: "/"
        limit_req:
          zone: unlimited
          burst: 10000
        configs:
          proxy_http_version: 1.1
          proxy_set_header: "Connection: $http_connection"
          proxy_buffering: off
          proxy_set_header: "Upgrade: $http_upgrade"
          auth_request_set: "$user: $upstream_http_x_forwarded_user"
          proxy_set_header: "X-Forwarded-User: $user"
          auth_request: "/authorize/authorize"
          auth_request_set: "$auth_status: $upstream_status"
          proxy_set_header: "Authorization: $http_authorization"
          proxy_pass_header: "Authorization"
          add_header: "Access-Control-Allow-Origin: files.gportal.link"
          proxy_pass: "http://10.13.13.2:2283"
