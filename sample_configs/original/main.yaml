limit_req_zones:
  - name: global
    key: $binary_remote_addr
    zone: global:10m
    rate: 100r/s
  - name: unlimited
    key: $binary_remote_addr
    zone: unlimited:10m
    rate: 10000r/s
  - name: medium
    key: $binary_remote_addr
    zone: medium:10m
    rate: 25r/s
  - name: strict
    key: $binary_remote_addr
    zone: strict:10m
    rate: 5r/s

proxy_cache_path:
  - path: cache
    levels: 1:2
    keys_zone: my_cache:10m
    max_size: 10g

limit_req_log_level: error
limit_req_status: 429

servers:
  - listen: 80
    name: "main_http"
    server_name: "*.gportal.link gportal.link"
    server_name_in_redirect: on
    if:
      - condition: $host ~* ^(grafana)\.gportal\.link$
        return: 404 https://gportal.link/404
    limit_req:
      - zone: global
        burst: 20
    add_header: "Content-Type: text/html"
    return: "301 https://$host$request_uri"
    add_header:
      - "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload"
  - listen: "[::]:443 ssl http2"
    name: "main_https"
    server_name: "www.gportal.link"
    server_name_in_redirect: on
    limit_req:
      - zone: global
        burst: 20
    ssl_certificate: "/etc/nginx/ssl/live/gportal.link/fullchain.pem"
    ssl_certificate_key: "/etc/nginx/ssl/live/gportal.link/privkey.pem"
    location:
      - path: "^~ /.well-known/acme-challenge"
        allow: all
        auth_basic: off
        root: "/var/www/certbot"
      - path: "/error_page/"
        proxy_pass: "http://home:8080/error_page/"
      - path: "/api/health/"
        proxy_pass: "http://home:8080/api/health"
        limit_req:
          - zone: strict
            burst: 5
      - path: "/static/"
        proxy_pass: "http://home:8080/static/"
      - path: "/blog/"
        proxy_pass: "https://gtsteffaniak.github.io/blog/"
      - path: "/build/"
        proxy_pass: "http://home:8080/build/"
      - path: "= /favicon.ico"
        proxy_pass: "http://home:8080/"
      - path: "/auth/"
        proxy_set_header: "content-type: application/json"
        set: "$auth_header: $cookie_api_key"
        if: "$cookie_api_key = ''"
        set: "$auth_header: $http_authorization"
        proxy_pass: "http://home:8080/auth/"
        proxy_pass_request_body: on
        proxy_set_header: "Authorization: $auth_header"
        proxy_pass_header: "Authorization"
        proxy_set_header: "X-Original-URI: $request_uri"
        limit_req:
          - zone: strict
      - path: "/login/"
        proxy_pass: "http://home:8080/login/"
        set: "$auth_header: $cookie_api_key"
        if: "$cookie_api_key = ''"
        set: "$auth_header: $http_authorization"
        proxy_set_header: "Authorization: $auth_header"
        proxy_pass_header: "Authorization"
      - path: "="
        add_header: "Cache-Control: no-cache"
        proxy_set_header: "Authorization: $http_authorization"
        proxy_pass_header: "Authorization"
        proxy_pass: "http://home:8080/"
        limit_req:
          - zone: strict
      - path: "/"
        auth_request_set: "$user: $upstream_http_x_forwarded_user"
        proxy_set_header: "X-Forwarded-User: $user"
        auth_request: "/auth/authorize"
        auth_request_set: "$auth_status: $upstream_status"
        proxy_set_header: "Authorization: $http_authorization"
        proxy_pass_header: "Authorization"
        add_header: "Access-Control-Allow-Origin: files.gportal.link"
        proxy_pass: "http://home:8080"
      - path: "/grafana/"
        auth_request_set: "$user: $upstream_http_x_forwarded_user"
        proxy_set_header: "X-Forwarded-User: $user"
        proxy_set_header: "Host: 10.13.13.2"
        proxy_set_header: "Origin: https://10.13.13.2"
        auth_request: "/auth/authorize"
        auth_request_set: "$auth_status: $upstream_status"
        proxy_pass: "http://10.13.13.2:3000/grafana/"
        proxy_set_header: "Authorization: $http_authorization"
        proxy_pass_header: "Authorization"
        add_header: "Access-Control-Allow-Origin: files.gportal.link"
      - path: "/shinobi/"
        limit_req:
          - zone: unlimited
            burst: 10000
        proxy_http_version: 1.1
        proxy_set_header: "Connection: $http_connection"
        proxy_buffering: off
        proxy_set_header: "Upgrade: $http_upgrade"
        auth_request_set: "$user: $upstream_http_x_forwarded_user"
        proxy_set_header: "X-Forwarded-User: $user"
        auth_request: "/auth/authorize"
        auth_request_set: "$auth_status: $upstream_status"
        proxy_set_header: "Authorization: $http_authorization"
        proxy_pass_header: "Authorization"
        add_header: "Access-Control-Allow-Origin: files.gportal.link"
        proxy_pass: "http://10.13.13.2:5555/"
      - path: "/photos/"
        proxy_http_version: 1.1
        proxy_set_header: "Connection: $http_connection"
        proxy_buffering: off
        proxy_set_header: "Upgrade: $http_upgrade"
        auth_request_set: "$user: $upstream_http_x_forwarded_user"
        proxy_set_header: "X-Forwarded-User: $user"
        auth_request: "/auth/authorize"
        auth_request_set: "$auth_status: $upstream_status"
        proxy_set_header: "Authorization: $http_authorization"
        proxy_pass_header: "Authorization"
        add_header: "Access-Control-Allow-Origin: files.gportal.link"
        proxy_pass: "http://10.13.13.2:2283"
      - path: "/search/"
        auth_request_set: "$user: $upstream_http_x_forwarded_user"
        auth_request: "/auth/authorize"
        auth_request_set: "$auth_status: $upstream_status"
        proxy_pass: "https://www.google.com/"

    return: "301 https://gportal.link$request_uri"
    absolute_redirect: off
    proxy_buffering: off
    proxy_buffer_size: 16m
    proxy_busy_buffers_size: 24m
    proxy_buffers:
      - 64 16m
    error_page:
      - "404 = @notfound"
      - "401 = @error401"
      - "429 = @error429"
      - "502 = @error502"

  - listen: "[::]:443 ssl http2"
    listen: "443 ssl http2"
    name: "photos"
    server_name: "photos.gportal.link"
    server_name_in_redirect: on
    ssl_certificate: "/etc/nginx/ssl/live/gportal.link/fullchain.pem"
    ssl_certificate_key: "/etc/nginx/ssl/live/gportal.link/privkey.pem"
    absolute_redirect: off
    proxy_buffering: off
    proxy_buffer_size: 16m
    proxy_busy_buffers_size: 24m
    proxy_buffers:
      - 64 16m
    limit_req:
      - zone: global
        burst: 20
    error_page:
      - "404 = @notfound"
      - "401 = @error401"
      - "429 = @error429"
      - "502 = @error502"
    location:
      - path: "^~ /.well-known/acme-challenge"
        allow: all
        auth_basic: off
        root: "/var/www/certbot"
      - path: "/share/"
        proxy_cache: my_cache
        proxy_cache_valid: "200 10m"
        proxy_cache_valid: "any 0"
        proxy_pass: "http://10.13.13.2:2283/share/"
      - path: "/api/asset/"
        limit_req:
          - zone: unlimited
            burst: 10000
        proxy_cache: my_cache
        proxy_cache_valid: "200 10m"
        proxy_cache_valid: "any 0"
        proxy_pass: "http://10.13.13.2:2283/api/asset/"
      - path: "/_app/immutable/"
        limit_req:
          - zone: unlimited
            burst: 10000
        proxy_cache: my_cache
        proxy_cache_valid: "200 10m"
        proxy_cache_valid: "any 0"
        proxy_pass: "http://10.13.13.2:2283/_app/immutable/"
      - path: "/authorize/"
        proxy_cache: my_cache
        proxy_cache_valid: "200 10m"
        proxy_cache_valid: "any 0"
        set: "$auth_header: $cookie_api_key"
        if: "$cookie_api_key = ''"
        set: "$auth_header: $http_authorization"
        proxy_pass: "http://home:8080/auth/"
        proxy_pass_request_body: off
        proxy_set_header: "Content-Length: ''"
        proxy_set_header: "Authorization: $auth_header"
        proxy_pass_header: "Authorization"
        proxy_set_header: "X-Original-URI: $request_uri"
        limit_req:
          - zone: strict
      - path: "/"
        limit_req:
          - zone: unlimited
            burst: 10000
        proxy_http_version: 1.1
        proxy_set_header: "Connection: $http_connection"
        proxy_buffering: off
        proxy_set_header: "Upgrade: $http_upgrade"
        auth_request_set: "$user: $upstream_http_x_forwarded_user"
        proxy_set_header: "X-Forwarded-User: $user"
        auth_request: "/authorize/authorize"
        auth_request_set: "$auth_status: $upstream_status"
        proxy_set_header: "Authorization: $http_authorization"
        proxy_pass_header: "Authorization"
        add_header: "Access-Control-Allow-Origin: files.gportal.link"
        proxy_pass: "http://10.13.13.2:2283"
